# pages/2_ë©”ë‰´ì¶”ì²œ.py
import streamlit as st
from pathlib import Path
from utils.ui import select_one_by_image, speak
from utils.gpt_helper import ask_gpt
from utils.ui import switch_page

# â”€â”€ í˜ì´ì§€ ì„¤ì • â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="â‘¢ ë©”ë‰´ ì¶”ì²œ", page_icon="ğŸ½ï¸")
st.markdown("""
    <div style='text-align: center; margin-top: -40px; margin-bottom: 30px;'>
        <h1>ğŸ³ ìš”ë¦¬ìš© ì±—ë´‡ ì˜¨ì¿¡</h1>
    </div>
""", unsafe_allow_html=True)

st.subheader("â‘¢ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ë¥¼ ê³¨ë¼ ì£¼ì„¸ìš”")
speak("ì˜¤ëŠ˜ ë§Œë“¤ ë©”ë‰´ë¥¼ í•˜ë‚˜ ê³¨ë¼ ì£¼ì„¸ìš”.")

# â”€â”€ ì„¸ì…˜ì—ì„œ ì´ì „ ë‹¨ê³„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ingredients = st.session_state.get("selected_ingredients", [])
tools       = st.session_state.get("selected_tools", [])
hand        = st.session_state.get("hand_status", "ê¹¨ë—í•´ìš”")

if not ingredients or not tools:
    st.error("ì´ì „ ë‹¨ê³„ì—ì„œ ì„ íƒí•œ ì¬ë£Œì™€ ë„êµ¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì§„í–‰í•´ ì£¼ì„¸ìš”.")
    st.stop()

# â”€â”€ GPT í”„ë¡¬í”„íŠ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
system_prompt = """ë‹¤ìŒì€ ìš”ë¦¬ ì´ë¦„ê³¼ í•´ë‹¹ ìš”ë¦¬ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ ê¼­ í•„ìš”í•œ ì¬ë£Œ ëª©ë¡ì´ì•¼:
- ê°„ì¥ê³„ë€ë°¥: ê³„ë€, ë°¥, ê°„ì¥
- ê³„ë€í›„ë¼ì´: ê³„ë€, ê¸°ë¦„
- ë¼ë©´: ë¼ë©´, ê³„ë€
- ì¹´ë ˆ: ì¹´ë ˆê°€ë£¨, ê°ì, ë‹¹ê·¼, ì–‘íŒŒ
- ìƒŒë“œìœ„ì¹˜: ì‹ë¹µ, í–„, ì¹˜ì¦ˆ
- í”¼ì: í”¼ìë„ìš°, ì¹˜ì¦ˆ, í† ë§ˆí† ì†ŒìŠ¤
- í–„ë²„ê±°: í–„ë²„ê±°ë¹µ, íŒ¨í‹°, ì¼€ì²©
- ì‚¼ê³„íƒ•: ë‹­, ì°¹ìŒ€, ë§ˆëŠ˜, íŒŒ, ë¶€ì¶”, ì‚¼ê³„íƒ•ìœ¡ìˆ˜íŒ©, ì†Œê¸ˆ
- ë°€í‘€ìœ ë‚˜ë² : ìˆ™ì£¼ë‚˜ë¬¼, ì•Œë°°ì¶”, ìƒ¤ë¸Œìƒ¤ë¸Œìš© ì†Œê³ ê¸°, ê¹»ì, íŒ½ì´ë²„ì„¯, í‘œê³ ë²„ì„¯, ë¬¼, ì½”ì¸ìœ¡ìˆ˜, êµ­ê°„ì¥, ì¯”ìœ 

ì‚¬ìš©ìê°€ ê°€ì§„ ì¬ë£Œ ëª©ë¡ì´ ì£¼ì–´ì§ˆ ê±°ì•¼. ê·¸ ì¬ë£Œë“¤ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ë¥¼ ì¶”ì²œí•´ì¤˜.

ì¶”ì²œí•  ë•ŒëŠ”:
1. ë§Œë“¤ ìˆ˜ ìˆëŠ” ìš”ë¦¬ í•œë‘ ê°œë§Œ ê°„ë‹¨íˆ ë§í•´ì¤˜.
2. ì™œ ê·¸ ìš”ë¦¬ë¥¼ ì¶”ì²œí–ˆëŠ”ì§€ ì¬ë£Œ ê´€ì ì—ì„œ ì§§ê²Œ ì„¤ëª…í•´ì¤˜.
3. ë„ˆë¬´ ê¸¸ê²Œ ì„¤ëª…í•˜ê±°ë‚˜ ì¡ë‹´í•˜ì§€ ë§ê³ , í•µì‹¬ë§Œ ë§í•´.
"""
user_prompt = f"ë‚´ê°€ ê°€ì§„ ì¬ë£ŒëŠ” {', '.join(ingredients)}ì•¼. ì–´ë–¤ ìš”ë¦¬ë¥¼ ë§Œë“¤ ìˆ˜ ìˆì–´?"

with st.spinner("GPTê°€ ê°€ëŠ¥í•œ ìš”ë¦¬ë¥¼ ìƒê° ì¤‘ì´ì—ìš”..."):
    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_prompt}
    ]
    gpt_response = ask_gpt(messages, model="gpt-4o")

# â”€â”€ GPT ì¶”ì²œ ê²°ê³¼ í‘œì‹œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.markdown("#### ğŸ³ GPT ì¶”ì²œ ê²°ê³¼")
st.markdown(gpt_response)

# â”€â”€ ë©”ë‰´ ì´ë¯¸ì§€ ëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
base_path = Path("data/menu")
menu_imgs = {
    "ê°„ì¥ê³„ë€ë°¥": base_path / "ê°„ì¥ê³„ë€ë°¥.png",
    "ê³„ë€í›„ë¼ì´": base_path / "ê³„ë€í›„ë¼ì´.png",
    "ë¼ë©´": base_path / "ë¼ë©´.png",
    "ë°€í‘€ìœ ë‚˜ë² ": base_path / "ë°€í‘€ìœ ë‚˜ë² .png",
    "ì‚¼ê³„íƒ•": base_path / "ì‚¼ê³„íƒ•.png",
    "ìƒŒë“œìœ„ì¹˜": base_path / "ìƒŒë“œìœ„ì¹˜.png",
    "ì¹´ë ˆ": base_path / "ì¹´ë ˆ.png",
    "í”¼ì": base_path / "í”¼ì.png",
    "í–„ë²„ê±°": base_path / "í–„ë²„ê±°.png",
    "í† ë§ˆí† ì¹´í”„ë ˆì œ": base_path / "í† ë§ˆí† ì¹´í”„ë ˆì œ.png",
    "í† ë§ˆí† ìŠ¤íŒŒê²Œí‹°": base_path / "í† ë§ˆí† ìŠ¤íŒŒê²Œí‹°.png",
    "ë“¤ê¸°ë¦„ë§‰êµ­ìˆ˜": base_path / "ë“¤ê¸°ë¦„ë§‰êµ­ìˆ˜.png",
}

# â”€â”€ ì‚¬ìš©ì ë©”ë‰´ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# â”€â”€ ë©”ë‰´ ì„ íƒ UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
select_one_by_image("ë©”ë‰´ë¥¼ ì„ íƒí•˜ì„¸ìš”", menu_imgs)

# â–¼â–¼â–¼ âŠ ì„ íƒí•œ ë©”ë‰´ëª… í‘œì‹œ (ë‘ ì¤„) â–¼â–¼â–¼
selected_menu = st.session_state.get("menu")
if selected_menu:
    st.markdown(f"### âœ… í˜„ì¬ ì„ íƒí•œ ë©”ë‰´: **{selected_menu}**")
# â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
col1, col2 = st.columns(2)

with col1:
    if st.button("â¬…ï¸ ì´ì „ ë‹¨ê³„"):
        st.switch_page("pages/1_ì¬ë£Œì„ íƒ.py")


with col2:
    if st.button("ìš”ë¦¬ ì‹œì‘í•˜ê¸° â–¶ï¸"):
        # â‘  ì‚¬ìš©ìê°€ í´ë¦­í•œ ë©”ë‰´ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ìš°ì„ , ì—†ìœ¼ë©´ GPT ê¸°ë³¸ ë©”ë‰´
        selected_menu = st.session_state.get("menu_selected", st.session_state.get("menu"))

        # â‘¡ ì•ˆì „ì¥ì¹˜: None ì´ë©´ ì—ëŸ¬ í‘œì‹œ
        if not selected_menu:
            st.warning("ë©”ë‰´ë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”!")
            st.stop()

        # â‘¢ ì„¸ì…˜ì— ìµœì¢… ë©”ë‰´ í™•ì •
        st.session_state["menu"] = selected_menu
        st.session_state["gpt_response"] = gpt_response

        # â‘£ í˜ì´ì§€ ì´ë™ (Streamlit Pages ì‚¬ìš© ì‹œ íŒŒì¼ëª…ì´ ì•„ë‹ˆë¼ ë©”ë‰´ëª…ìœ¼ë¡œ)
        st.switch_page("3_ë§Œë“œëŠ”ë°©ë²•")      # ë˜ëŠ” switch_page("pages/3_ë§Œë“œëŠ”ë°©ë²•.py") ìœ í‹¸ í•¨ìˆ˜ ê·œì¹™ì— ë§ê²Œ
