import streamlit as st
from pathlib import Path
from utils.ui import select_one_by_image, speak
from utils.gpt_helper import ask_gpt

# â”€â”€ í˜ì´ì§€ ê¸°ë³¸ ì„¤ì • â”€â”€
st.set_page_config(page_title="â‘¢ ë©”ë‰´ ì„ íƒ", page_icon="ğŸ½ï¸")

st.markdown("""
    <div style='text-align: center; margin-top: -40px; margin-bottom: 30px;'>
        <h1>ğŸ³ ìš”ë¦¬ìš© ì±—ë´‡ ì˜¨ì¿¡</h1>
    </div>
""", unsafe_allow_html=True)

st.subheader("â‘¢ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë©”ë‰´ë¥¼ ì¶”ì²œí• ê²Œìš”")
speak("ì„ íƒí•œ ì¬ë£Œë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ë©”ë‰´ë¥¼ ì¶”ì²œí• ê²Œìš”.")

# â”€â”€ ì‚¬ìš©ì ì„ íƒ ì¬ë£Œ ê°€ì ¸ì˜¤ê¸° â”€â”€
user_ingredients = set(st.session_state.get("selected_ingredients", []))

# â”€â”€ ë©”ë‰´ í›„ë³´ ëª©ë¡ (menu_db) â”€â”€
menu_db = {
    "ê°„ì¥ê³„ë€ë°¥": {"í•„ìˆ˜ì¬ë£Œ": ["ê³„ë€", "ë°¥", "ê°„ì¥"], "ì¶”ì²œì¬ë£Œ": ["ì°¸ê¸°ë¦„", "ê¹€ê°€ë£¨"]},
    "ê³„ë€í›„ë¼ì´": {"í•„ìˆ˜ì¬ë£Œ": ["ê³„ë€", "ê¸°ë¦„"], "ì¶”ì²œì¬ë£Œ": ["ì†Œê¸ˆ", "ë²„í„°"]},
    "ë¼ë©´": {"í•„ìˆ˜ì¬ë£Œ": ["ë¼ë©´"], "ì¶”ì²œì¬ë£Œ": ["ê³„ë€", "íŒŒ", "ê¹€ì¹˜"]},
    "ì‚¼ê³„íƒ•": {"í•„ìˆ˜ì¬ë£Œ": ["ë‹­", "ì°¹ìŒ€", "ë§ˆëŠ˜"], "ì¶”ì²œì¬ë£Œ": ["ëŒ€ì¶”", "ì¸ì‚¼", "íŒŒ", "ì†Œê¸ˆ"]},
    "ìƒŒë“œìœ„ì¹˜": {"í•„ìˆ˜ì¬ë£Œ": ["ì‹ë¹µ", "í–„", "ì¹˜ì¦ˆ"], "ì¶”ì²œì¬ë£Œ": ["ê³„ë€", "ì–‘ìƒì¶”", "ë§ˆìš”ë„¤ì¦ˆ", "í† ë§ˆí† "]},
    "ì¹´ë ˆ": {"í•„ìˆ˜ì¬ë£Œ": ["ì¹´ë ˆê°€ë£¨", "ê°ì", "ë‹¹ê·¼", "ì–‘íŒŒ"], "ì¶”ì²œì¬ë£Œ": ["ê³ ê¸°", "ë¸Œë¡œì½œë¦¬", "ìš°ìœ "]},
    "í”¼ì": {"í•„ìˆ˜ì¬ë£Œ": ["í”¼ìë„ìš°", "ì¹˜ì¦ˆ", "í† ë§ˆí† ì†ŒìŠ¤"], "ì¶”ì²œì¬ë£Œ": ["í˜í¼ë¡œë‹ˆ", "ì–‘íŒŒ", "íŒŒí”„ë¦¬ì¹´", "ì˜¬ë¦¬ë¸Œ"]},
    "í–„ë²„ê±°": {"í•„ìˆ˜ì¬ë£Œ": ["í–„ë²„ê±°ë¹µ", "íŒ¨í‹°"], "ì¶”ì²œì¬ë£Œ": ["ì–‘ìƒì¶”", "ì¹˜ì¦ˆ", "í† ë§ˆí† ", "ì–‘íŒŒ", "ì¼€ì°¹"]}
}

# â”€â”€ 1ë‹¨ê³„: í›„ë³´ ë©”ë‰´ í•„í„°ë§ â”€â”€
candidate_menus = []
for menu_name, info in menu_db.items():
    if set(info["í•„ìˆ˜ì¬ë£Œ"]).issubset(user_ingredients):
        candidate_menus.append(menu_name)

# â”€â”€ 2ë‹¨ê³„: GPTì—ê²Œ ì¶”ì²œ ìš”ì²­ â”€â”€
if candidate_menus:
    gpt_prompt = f"""
ì‚¬ìš©ì ì¬ë£Œ: {', '.join(user_ingredients)}
í›„ë³´ ë©”ë‰´: {', '.join(candidate_menus)}

ìœ„ í›„ë³´ ì¤‘ì—ì„œ ê°€ì¥ ë§Œë“¤ê¸° ì‰¬ìš´ ë©”ë‰´ 1ê°€ì§€ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.
'ì¶”ì²œ ë©”ë‰´: ë©”ë‰´ì´ë¦„' í˜•ì‹ìœ¼ë¡œ ë”± í•œ ì¤„ë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”.
"""
else:
    gpt_prompt = f"""
ì‚¬ìš©ì ì¬ë£Œ: {', '.join(user_ingredients)}

ì´ ì¬ë£Œë“¤ë¡œ ë§Œë“¤ ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ ìš”ë¦¬ í•˜ë‚˜ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”.
ì¶”ì²œ ë©”ë‰´ ì´ë¦„ë§Œ ì¶œë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: ì¶”ì²œ ë©”ë‰´: ê³„ë€êµ­
"""

# â”€â”€ GPT í˜¸ì¶œ â”€â”€
response = ask_gpt([
    {"role": "system", "content": "ë‹¹ì‹ ì€ ìš”ë¦¬ ì¶”ì²œ ë„ìš°ë¯¸ì…ë‹ˆë‹¤."},
    {"role": "user", "content": gpt_prompt}
])

# â”€â”€ ê²°ê³¼ íŒŒì‹± â”€â”€
menu_name = response.strip().replace("ì¶”ì²œ ë©”ë‰´:", "").strip()
st.session_state["menu"] = menu_name

# â”€â”€ ë©”ë‰´ ì´ë¯¸ì§€ ì„ íƒ UI â”€â”€
menu_imgs = {p.stem: p for p in Path("data/menu").glob("*.png")}

if menu_name in menu_imgs:
    st.image(menu_imgs[menu_name], caption=f"GPT ì¶”ì²œ ë©”ë‰´: {menu_name}")
else:
    st.warning(f"'{menu_name}' ë©”ë‰´ ì´ë¯¸ì§€ê°€ ì—†ì–´ìš”. ëª©ë¡ ì¤‘ í•˜ë‚˜ë¥¼ ê³¨ë¼ì£¼ì„¸ìš”.")

# ì‚¬ìš©ì ìˆ˜ë™ ì„ íƒë„ í—ˆìš©
selected = select_one_by_image("ë§ˆìŒì— ë“œëŠ” ë©”ë‰´ë¥¼ í•˜ë‚˜ ì„ íƒí•˜ì„¸ìš”", menu_imgs)

if selected and st.button("ìš”ë¦¬ ì‹œì‘ â–¶ï¸"):
    st.session_state["menu"] = selected
    st.switch_page("pages/3_Assistant.py")
